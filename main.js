/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var E=Object.defineProperty;var O=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var M=Object.prototype.hasOwnProperty;var x=(p,i)=>{for(var e in i)E(p,e,{get:i[e],enumerable:!0})},I=(p,i,e,t)=>{if(i&&typeof i=="object"||typeof i=="function")for(let s of R(i))!M.call(p,s)&&s!==e&&E(p,s,{get:()=>i[s],enumerable:!(t=O(i,s))||t.enumerable});return p};var A=p=>I(E({},"__esModule",{value:!0}),p);var H={};x(H,{default:()=>T});module.exports=A(H);var d=require("obsidian");var f=40,B=3e3,D=3e3,v="search-results-view",F=[{value:"title",label:"Note title"},{value:"modified",label:"Last Edited"},{value:"created",label:"Created"}];function b(p){return(p.match(/\[\[(.*?)\]\]/g)||[]).map(e=>e.slice(2,-2).split("|")[0].trim())}var S=class{static extractProperties(i,e){let t=new Map;for(let s of i){let r=e.metadataCache.getFileCache(s.file);if(r!=null&&r.frontmatter)for(let[n,o]of Object.entries(r.frontmatter)){if(o==null)continue;t.has(n)||t.set(n,new Set);let a=t.get(n);Array.isArray(o)?o.forEach(l=>l&&a.add(l.toString())):a.add(o.toString())}}return t}};function c(p,i,e={}){return p.createEl(i,{text:e.text,cls:e.cls,attr:e.attributes})}var y=class{constructor(i,e,t,s){this.suggestions=[];this.selectedIndex=-1;this.isVisible=!1;this.isDropdownListenerActive=!1;this.onInput=()=>{let i=this.inputEl.value.toLowerCase();this.suggestions=this.getAllLinkTargets().filter(e=>e.toLowerCase().includes(i)),this.selectedIndex=-1,this.renderSuggestions(),this.isDropdownListenerActive||(this.isDropdownListenerActive=!0,document.addEventListener("mousedown",this.closeDropdownListener))};this.onKeyDown=i=>{if(this.isVisible)switch(i.key){case"ArrowDown":i.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,this.suggestions.length-1),this.highlightSelected();break;case"ArrowUp":i.preventDefault(),this.selectedIndex=Math.max(this.selectedIndex-1,-1),this.highlightSelected();break;case"Enter":i.preventDefault(),this.handleEnterPress(i);break;case"Escape":this.close();break}};this.app=i,this.inputEl=e,this.containerEl=t,this.onSelect=s,this.suggestionsEl=c(this.containerEl,"div",{cls:"linklens-suggestion-container"}),this.inputEl.addEventListener("input",this.onInput),this.inputEl.addEventListener("keydown",this.onKeyDown),this.closeDropdownListener=r=>{this.containerEl.contains(r.target)||(this.close(),document.removeEventListener("mousedown",this.closeDropdownListener),this.isDropdownListenerActive=!1)}}destroy(){this.inputEl.removeEventListener("input",this.onInput),this.inputEl.removeEventListener("keydown",this.onKeyDown),this.suggestionsEl.remove(),document.removeEventListener("mousedown",this.closeDropdownListener)}getAllLinkTargets(){let i=this.app.vault.getMarkdownFiles(),e=i.map(s=>s.basename),t=new Set;for(let s of i){let r=this.app.metadataCache.getFileCache(s);if(r!=null&&r.links)for(let n of r.links){let o=n.link.split("|")[0].trim();e.includes(o)||t.add(o)}}return[...e,...t]}renderSuggestions(){if(this.suggestionsEl.empty(),this.suggestions.length===0){this.isVisible=!1,this.suggestionsEl.style.display="none";return}this.isVisible=!0,this.suggestionsEl.style.display="block",this.updateDropdownPosition();for(let i=0;i<this.suggestions.length;i++)this.renderSuggestionItem(i)}updateDropdownPosition(){let i=this.containerEl.getBoundingClientRect(),e=this.inputEl.getBoundingClientRect();this.suggestionsEl.style.top=`${e.bottom-i.top}px`,this.suggestionsEl.style.left=`${e.left-i.left}px`,this.suggestionsEl.style.width=`${e.width}px`}renderSuggestionItem(i){let e=this.suggestions[i],t=c(this.suggestionsEl,"div",{text:e,cls:"suggestion-item"});i===this.selectedIndex&&t.classList.add("selected"),t.addEventListener("mousedown",s=>{s.preventDefault();let r=this.getOperatorFromEvent(s);this.onSelect(e,!1,r),this.close()}),t.addEventListener("mouseover",()=>{this.selectedIndex=i,this.highlightSelected()})}highlightSelected(){this.suggestionsEl.querySelectorAll(".suggestion-item").forEach((e,t)=>{e.classList.toggle("selected",t===this.selectedIndex)})}handleEnterPress(i){let e=this.getOperatorFromEvent(i);if(this.selectedIndex>=0&&this.suggestions[this.selectedIndex])this.onSelect(this.suggestions[this.selectedIndex],!1,e);else{let t=this.inputEl.value.trim();t&&this.onSelect(t,!0,e)}this.close()}getOperatorFromEvent(i){return i.ctrlKey&&i.shiftKey?"NOT":i.shiftKey?"OR":"AND"}close(){this.isVisible=!1,this.selectedIndex=-1,this.isDropdownListenerActive=!1,this.suggestionsEl.style.display="none"}},L=class extends d.ItemView{constructor(e){super(e);this.searchResults=[];this.suggestionDropdown=null;this.currentSearchTerms=[];this.wasCtrlKeyPressed=!1;this.wasShiftKeyPressed=!1;this.currentSortType="title";this.isSortAscending=!0;this.orOperatorWarningPopup=null}dedentBlock(e){let t=e.split(`
`),s=1/0;for(let r of t){if(r.trim()==="")continue;let n=r.match(/^\s*/),o=n?n[0].length:0;o<s&&(s=o)}return s===1/0&&(s=0),t.map(r=>r.substring(s)).join(`
`)}cleanupTimeouts(){this.orOperatorWarningPopup&&clearTimeout(this.orOperatorWarningPopup.timeout)}getViewType(){return v}getDisplayText(){return"Link Search"}getIcon(){return"search"}async onOpen(){this.setupUI(),this.searchInputEl.focus()}setupUI(){let e=this.containerEl.children[1];e.empty(),e.classList.add("search-main-container"),this.createSearchBar(e),this.setupPropertyButtonsContainer(),this.setupTagsContainer(),this.setupSuggestedTagsContainer(),this.setupResultsContainer()}createSearchBar(e){let t=c(e,"div",{cls:"search-bar-container"}),s=c(t,"form",{cls:"search-bar-form"});this.searchInputEl=c(s,"input",{attributes:{type:"text",placeholder:"Type a link name and press Enter..."},cls:"search-input"}),this.setupInputListeners(s),this.setupDropdown(t)}setupInputListeners(e){this.searchInputEl.addEventListener("keydown",t=>{this.wasCtrlKeyPressed=t.ctrlKey,this.wasShiftKeyPressed=t.shiftKey}),e.addEventListener("submit",t=>{t.preventDefault(),this.handleFormSubmit()})}setupDropdown(e){this.suggestionDropdown=new y(this.app,this.searchInputEl,e,(t,s,r)=>{this.addSearchTerm(t,s,r),this.searchInputEl.value=""})}handleFormSubmit(){let e=this.getOperatorFromKeys(),t=this.searchInputEl.value.trim();if(!t)return;let r=this.app.vault.getMarkdownFiles().some(n=>n.basename.toLowerCase()===t.toLowerCase());this.addSearchTerm(t,!r,e),this.searchInputEl.value=""}getOperatorFromKeys(){return this.wasCtrlKeyPressed&&this.wasShiftKeyPressed?"NOT":this.wasShiftKeyPressed?"OR":"AND"}setupPropertyButtonsContainer(){this.propertyButtonsContainerEl=c(this.containerEl.children[1],"div",{cls:"property-buttons-container"})}setupTagsContainer(){let e=c(this.containerEl.children[1],"div",{cls:"tags-row"});this.activeTagsContainerEl=c(e,"div",{cls:"tags-container"})}setupSuggestedTagsContainer(){let e=c(this.containerEl.children[1],"div",{cls:"suggested-tags-row"});this.suggestedTagsContainerEl=c(e,"div",{cls:"suggested-tags-container"})}setupResultsContainer(){this.resultsContainerEl=c(this.containerEl.children[1],"div",{cls:"results-container"})}addSearchTerm(e,t=!1,s="AND"){e=e.trim(),!(!e||this.termExists(e,s))&&(this.currentSearchTerms.push({term:e,isTextSearch:t,operator:s}),this.renderSearchTags(),this.handleOperatorWarning(),this.executeSearch(),this.searchInputEl.focus())}termExists(e,t){return this.currentSearchTerms.some(s=>s.term===e&&s.operator===t)}handleOperatorWarning(){let e=this.currentSearchTerms.filter(t=>t.operator==="OR").length;e===1?this.showOrOperatorWarning():e===2&&this.orOperatorWarningPopup&&this.hideOrOperatorWarning()}renderSearchTags(){this.activeTagsContainerEl.empty(),["AND","OR","NOT"].forEach(t=>{this.currentSearchTerms.filter(s=>s.operator===t).forEach(s=>this.createTagElement(s))})}createTagElement(e){let t=c(this.activeTagsContainerEl,"div",{cls:"search-tag-wrapper"});c(t,"div",{text:e.operator,cls:"search-tag-operator-label"});let s=e.term.length>f?`${e.term.slice(0,f)}\u2026`:e.term;c(t,"button",{text:s,cls:e.isTextSearch?"search-tag-text":"search-tag",attributes:{title:e.term}}).addEventListener("click",n=>{n.stopPropagation(),this.removeSearchTerm(e.term,e.operator)})}removeSearchTerm(e,t){this.currentSearchTerms=this.currentSearchTerms.filter(s=>!(s.term===e&&s.operator===t)),this.renderSearchTags(),this.executeSearch(),this.currentSearchTerms.length===0&&this.updateSuggestedTags()}async executeSearch(){if(this.currentSearchTerms.length===0){this.showMessage("No search terms"),this.searchResults=[],this.updatePropertyButtons(),this.updateSuggestedTags();return}this.showMessage("Searching...");try{let e=await this.findLinkedBlocksForMultiple(this.currentSearchTerms);this.updateSearchResults(e)}catch(e){this.showMessage(`Error during search: ${e.message}`)}}async findLinkedBlocksForMultiple(e){e=this.filterOrphanORTerms(e);let{normalTerms:t,propertyFilters:s}=this.categorizeTerms(e),{andTerms:r,orTerms:n,notTerms:o}=this.groupNormalTerms(t),a=[],l=this.app.vault.getMarkdownFiles();for(let h of l){if(!this.filePassesPropertyFilters(h,s))continue;let u=this.app.metadataCache.getFileCache(h);if(!(u!=null&&u.sections))continue;let g=(await this.app.vault.cachedRead(h)).split(`
`);for(let m of u.sections)m.position&&this.processSection(m,g,r,n,o,h,a)}return this.groupResultsByFile(a)}filterOrphanORTerms(e){return e.filter(s=>s.operator==="OR").length===1?e.filter(s=>s.operator!=="OR"):e}categorizeTerms(e){let t=[],s={AND:{},OR:{},NOT:{}};for(let r of e)if(r.term.includes(":")&&!r.isTextSearch){let[n,o]=r.term.split(":").map(l=>l.trim()),a=r.operator;s[a][n]||(s[a][n]=new Set),s[a][n].add(o)}else t.push(r);return{normalTerms:t,propertyFilters:s}}groupNormalTerms(e){return{andTerms:e.filter(t=>t.operator==="AND"),orTerms:e.filter(t=>t.operator==="OR"),notTerms:e.filter(t=>t.operator==="NOT")}}filePassesPropertyFilters(e,t){let s=this.app.metadataCache.getFileCache(e),r=(s==null?void 0:s.frontmatter)||{};for(let[n,o]of Object.entries(t.AND)){let a=r[n];if(a==null||!this.propertyValueMatches(a,o))return!1}if(Object.keys(t.OR).length>0){let n=!1;for(let[o,a]of Object.entries(t.OR)){let l=r[o];if(l!=null&&this.propertyValueMatches(l,a)){n=!0;break}}if(!n)return!1}for(let[n,o]of Object.entries(t.NOT)){let a=r[n];if(a!=null&&this.propertyValueMatches(a,o))return!1}return!0}propertyValueMatches(e,t){return Array.isArray(e)?Array.from(t).some(s=>e.includes(s)):t.has(e.toString())}processSection(e,t,s,r,n,o,a){if(!["paragraph","table","list","footnoteDefinition","callout"].includes(e.type))return;let h=e.position.start.line,u=e.position.end.line;e.type==="list"?this.processListSection(e,h,u,t,s,r,n,o,a):this.processStandardSection(h,u,t,s,r,n,o,a)}processListSection(e,t,s,r,n,o,a,l,h){let u=this.app.metadataCache.getFileCache(l);((u==null?void 0:u.listItems)||[]).filter(g=>g.position.start.line>=t&&g.position.end.line<=s).forEach(g=>{let m=g.position.start.line,w=g.position.end.line,k=r.slice(m,w+1).join(`
`);this.blockMatchesTerms(k,n,o,a)&&h.push({content:k,startLine:m,endLine:w,file:l})})}processStandardSection(e,t,s,r,n,o,a,l){let h=s.slice(e,t+1).join(`
`);this.blockMatchesTerms(h,r,n,o)&&l.push({content:h,startLine:e,endLine:t,file:a})}blockMatchesTerms(e,t,s,r){let n=t.every(l=>this.blockMatchesTerm(e,l)),o=s.length===0||s.some(l=>this.blockMatchesTerm(e,l)),a=r.every(l=>!this.blockMatchesTerm(e,l));return n&&o&&a}blockMatchesTerm(e,t){return t.isTextSearch?e.toLowerCase().includes(t.term.toLowerCase()):b(e).map(s=>s.toLowerCase()).includes(t.term.toLowerCase())}groupResultsByFile(e){let t=new Map;for(let s of e){let r=s.file.path;t.has(r)||t.set(r,{file:s.file,blocks:[]}),t.get(r).blocks.push({content:s.content,startLine:s.startLine,endLine:s.endLine})}return Array.from(t.values())}updateSearchResults(e){this.searchResults=e,this.renderSearchResults(),this.updatePropertyButtons(),this.updateSuggestedTags()}updatePropertyButtons(){if(!this.propertyButtonsContainerEl||(this.propertyButtonsContainerEl.empty(),this.currentSearchTerms.length===0))return;S.extractProperties(this.searchResults,this.app).forEach((s,r)=>{let n=c(this.propertyButtonsContainerEl,"button",{cls:"property-button"}),o=c(n,"span",{cls:"property-button-content"});c(o,"span",{text:r,cls:"property-button-text"}),c(o,"span",{text:"\u2193",cls:"property-button-arrow"}),n.addEventListener("click",a=>{a.preventDefault(),this.showPropertyDropdown(n,r,Array.from(s))})}),c(this.propertyButtonsContainerEl,"button",{text:"\u21BB",cls:"refresh-button"}).addEventListener("click",()=>this.executeSearch())}showPropertyDropdown(e,t,s){this.containerEl.querySelectorAll(".property-dropdown").forEach(n=>n.remove());let r=c(this.containerEl,"div",{cls:"property-dropdown"});this.positionDropdown(e,r),s.forEach(n=>{c(r,"div",{text:n,cls:"property-dropdown-item"}).addEventListener("click",a=>{let l=this.getOperatorFromEvent(a);this.addSearchTerm(`${t}:${n}`,!1,l),r.remove(),a.stopPropagation()})}),this.setupDropdownCloseHandler(r)}positionDropdown(e,t){let s=e.getBoundingClientRect(),r=this.containerEl.getBoundingClientRect();t.style.top=`${s.bottom-r.top+5}px`,t.style.left=`${s.left-r.left}px`}getOperatorFromEvent(e){return e.ctrlKey&&e.shiftKey?"NOT":e.shiftKey?"OR":"AND"}setupDropdownCloseHandler(e){let t=s=>{e.contains(s.target)||(e.remove(),document.removeEventListener("click",t))};setTimeout(()=>document.addEventListener("click",t),0)}updateSuggestedTags(){if(!this.suggestedTagsContainerEl||(this.suggestedTagsContainerEl.empty(),this.currentSearchTerms.length===0))return;c(this.suggestedTagsContainerEl,"span",{text:"Related links: ",cls:"suggested-label"});let e=c(this.suggestedTagsContainerEl,"input",{attributes:{type:"text",placeholder:"Filter..."},cls:"suggested-filter-input"}),t=c(this.suggestedTagsContainerEl,"div",{cls:"suggested-tags-buttons"}),s=this.collectUniqueLinks();this.renderFilteredTags(t,s,""),e.addEventListener("input",()=>{t.empty(),this.renderFilteredTags(t,s,e.value)})}collectUniqueLinks(){let e=new Set;return this.searchResults.forEach(t=>{t.blocks.forEach(s=>{b(s.content).forEach(r=>{this.isCurrentSearchTerm(r)||e.add(r)})})}),Array.from(e)}isCurrentSearchTerm(e){return this.currentSearchTerms.some(t=>t.term.toLowerCase()===e.toLowerCase())}renderFilteredTags(e,t,s){t.filter(n=>n.toLowerCase().includes(s.toLowerCase())).forEach(n=>{let o=n.length>f?`${n.slice(0,f)}\u2026`:n;c(e,"button",{text:o,cls:"suggested-tag",attributes:{title:n}}).addEventListener("click",l=>{let h=this.getOperatorFromEvent(l);this.addSearchTerm(n,!1,h)})})}showMessage(e){this.resultsContainerEl.empty(),c(this.resultsContainerEl,"p",{text:e})}async renderSearchResults(){if(this.resultsContainerEl.empty(),this.searchResults.length===0){c(this.resultsContainerEl,"p",{text:"No matches found."});return}this.renderResultsHeader(),await this.renderResultsContent()}renderResultsHeader(){let e=c(this.resultsContainerEl,"div",{cls:"search-header-row"}),t=this.searchResults.reduce((a,l)=>a+l.blocks.length,0),s=this.searchResults.length;c(e,"div",{text:`Found ${t} result${t!==1?"s":""} in ${s} note${s!==1?"s":""}`,cls:"search-summary"});let r=c(e,"div",{cls:"search-sort-container"});c(r,"span",{text:"Sort by:",cls:"sort-label"});let n=c(r,"select",{cls:"sort-select"});F.forEach(a=>{let l=c(n,"option",{text:a.label,attributes:{value:a.value}});l.selected=a.value===this.currentSortType});let o=c(r,"span",{text:this.isSortAscending?"\u2191":"\u2193",cls:"sort-arrow"});o.title="Toggle sort order",n.addEventListener("change",()=>{this.currentSortType=n.value,this.renderSearchResults()}),o.addEventListener("click",()=>{this.isSortAscending=!this.isSortAscending,o.textContent=this.isSortAscending?"\u2191":"\u2193",this.renderSearchResults()})}async renderResultsContent(){let e=this.getSortedResults();for(let t of e){let s=c(this.resultsContainerEl,"div",{cls:"search-result-file"}),r=c(s,"div",{cls:"file-header-content"});c(r,"h4",{text:t.file.basename}).addEventListener("click",()=>{this.app.workspace.openLinkText(t.file.path,"")});for(let o of t.blocks)await this.renderBlockContent(t.file,o)}}getSortedResults(){return[...this.searchResults].sort((e,t)=>{if(this.currentSortType==="title")return this.isSortAscending?e.file.basename.localeCompare(t.file.basename):t.file.basename.localeCompare(e.file.basename);let s=this.currentSortType==="modified"?e.file.stat.mtime:e.file.stat.ctime,r=this.currentSortType==="modified"?t.file.stat.mtime:t.file.stat.ctime;return this.isSortAscending?s-r:r-s})}async renderBlockContent(e,t){let s=c(this.resultsContainerEl,"div",{cls:"block-container"}),r=c(s,"div",{cls:"block-content-container"}),n=c(r,"div",{cls:"block-content"}),l=(await this.app.vault.read(e)).split(`
`).slice(t.startLine,t.endLine+1).join(`
`),h=this.dedentBlock(l);d.MarkdownRenderer.render(this.app,h,n,e.path,this),this.addBlockActions(s,e,t)}addBlockActions(e,t,s){let r=c(e,"div",{cls:"block-link-container"});c(r,"a",{cls:"block-action",attributes:{href:"#",title:"Copy block content"},text:"\u{1F4CB}"}).addEventListener("click",a=>{a.preventDefault(),navigator.clipboard.writeText(s.content),new d.Notice("Block content copied to clipboard")}),c(r,"a",{cls:"block-action",attributes:{href:"#",title:"Open link"},text:"\u{1F517}"}).addEventListener("click",a=>{a.preventDefault(),this.openBlockInEditor(t,s)})}async openBlockInEditor(e,t){let s=this.app.workspace.getLeaf(!1);if(await s.openFile(e),s.view instanceof d.MarkdownView){let r=s.view.editor,o=(await this.app.vault.read(e)).split(`
`),a=this.determineTargetLine(o,t);r.setCursor({line:a,ch:0}),r.scrollIntoView({from:{line:Math.max(0,a-3),ch:0},to:{line:t.endLine+3,ch:0}},!0),this.highlightEditorBlock(r,t.startLine,t.endLine)}}determineTargetLine(e,t){if(e.slice(t.startLine,t.endLine+1).every(r=>r.trim().startsWith("|"))){for(let r=t.startLine;r<=t.endLine;r++)if(e[r].trim().startsWith("|"))return r}return t.startLine}highlightEditorBlock(e,t,s){let r=e.cm;if(!r||typeof r.getAllMarks!="function")return;r.getAllMarks().forEach(l=>l.clear());let n={line:t,ch:0},o={line:s,ch:e.getLine(s).length},a=r.markText(n,o,{className:"block-highlight"});setTimeout(()=>a.clear(),B)}showOrOperatorWarning(){this.hideOrOperatorWarning();let e=this.activeTagsContainerEl.querySelectorAll(".search-tag-wrapper"),t=Array.from(e).find(n=>{var o;return((o=n.querySelector(".search-tag-operator-label"))==null?void 0:o.textContent)==="OR"});if(!t)return;let s=c(document.body,"div",{text:"OR operator needs at least two search terms to work",cls:"or-operator-warning"}),r=t.getBoundingClientRect();s.style.left=`${r.left+window.scrollX}px`,s.style.top=`${r.top+window.scrollY-38}px`,this.orOperatorWarningPopup={popup:s,timeout:setTimeout(()=>this.hideOrOperatorWarning(),D)}}hideOrOperatorWarning(){this.orOperatorWarningPopup&&(clearTimeout(this.orOperatorWarningPopup.timeout),this.orOperatorWarningPopup.popup.remove(),this.orOperatorWarningPopup=null)}async onClose(){this.suggestionDropdown&&this.suggestionDropdown.destroy(),this.hideOrOperatorWarning(),this.cleanupTimeouts()}},T=class extends d.Plugin{async onload(){this.registerView(v,i=>new L(i)),this.addCommand({id:"open-search-view",name:"Open Search Panel",callback:()=>this.activateView()})}async activateView(){this.app.workspace.detachLeavesOfType(v);let i=this.app.workspace.getRightLeaf(!1);i&&(await i.setViewState({type:v,active:!0}),this.app.workspace.revealLeaf(i))}};
